
遊戲名稱：《死靈召魂象棋》（DeadNecroChess）
核心玩法：2 人回合制象棋變體 + 靈魂附魔 + HP 射擊 + 屍骸循環 + 墳場掠奪
規則已定稿 v1.0（HackMD 文件已整理）
美術方向：極簡 CSS 原生 + 少量卡片圖片，暫不大量依賴外部素材
開發階段：一人開發 + 朋友小團體測試，尚未正式動工（幾天後開工才有環境）

技術路線（目前實作狀態）

前端：Vue 3 + Vite + Pinia + TypeScript（無 Tailwind，純 CSS scoped）
後端：無（單機 / 本機對戰，引擎完全在前端執行）
部署：已部署至網路，具備正式 domain（靜態頁面 hosting）
未來擴充（尚未實作）：Node.js + Socket.IO 線上對戰；Electron 桌面打包
資源處理：圖片放 public/assets/cards/，靈魂卡資料以 JSON 驅動（souls/*.json）
資料持久化：目前無持久化，每次重新開始為全新對局

已確認的頁面結構（第一版 MVP）

首頁（Landing）→ 主題介紹 + 開始遊戲 / 瀏覽牌庫 / 教學按鈕
牌庫展示頁 → 驗證所有卡牌（你自己最常用）
教學 / 規則頁 → 完整規則說明（HackMD 內容直接用）
創建 / 加入房間頁 → 輸入房間 ID 或建立新房間
遊戲戰鬥頁 → 核心畫面（棋盤 + 手牌 + 資源 + 階段切換）
遊戲結束 / 結算頁 → 勝負顯示 + 返回大廳
（可選）遊戲內小菜單 → 投降 / 返回 / 規則 / 設定

關鍵機制已確定

狀態同步：伺服器權威 + Socket.IO 全狀態廣播
重新同步：需 API（GET /api/game/:roomId/state） + Socket.IO requestState
斷線重連：visibilitychange + localStorage roomId + 自動同步
結束條件：投降 / 帥耐久歸零 / 長時間無行動自動投降
特效方向：先純 CSS + Canvas（翻牌、粒子、傷害飛出），後期可加 PixiJS

目前最容易遺忘 / 容易卡住的點（開工前提醒）

Git repo 是否已建立（建議用 GitLab public repo）
Render 帳號是否已註冊並授權 GitHub
Node.js 版本（建議 20 LTS）
Electron 打包流程是否已跑通（dev / build）
souls.json 是否先寫 5–10 張（至少跑通卡牌顯示）
棋盤座標系統先定義好（a1～i10 或 0,0～8,9）
第一個測試目標：兩人進房間能互相看到「移動棋子」

---

## 目前進度（實作狀態摘要）

### 引擎核心
- Engine 具備完整 reducer + guards + ShotPlan 執行架構（TypeScript）。
- 引擎測試（Vitest）目前全綠，每次變更均跑完整測試套件驗證。

### 氏族與卡牌
- **4 個氏族**全數實作完成並納入預設卡池：暗月影刃、冥河焰巫、永夜骸骨、鐵衛軍魂。
- 靈魂卡資料完全以 JSON 驅動（`src/data/souls/*.json`），abilities schema 支援多種 type（IGNORE_BLOCKING、CHAIN、PIERCE、ARMY_RALLY、LOGISTICS_REVIVE、SOLDIERS_TIERED_* 等）。
- 鐵衛氏族【軍勢】條件判斷、【軍援】追加攻擊、【整編】/【後勤】免費復活均已實作。

### 道具系統
- 道具卡完整實作：`USE_ITEM_FROM_HAND` action + 8 張道具各自效果引擎邏輯。
- 道具使用 UI 已整合至 Game.vue（有目標選擇模式、確認彈窗、二選一 UI for 骸骨煉化）。
- 死靈術 flags（itemNecroBonus、freeShootBonus、lastStandContractBonus 等）均在 NEXT_PHASE 時自動重置。

### UI / UX
- 射擊 UX 為「preview-first」：點目標後不立即射擊，必須明確 Confirm（Enter）。
- 多目標效果（貫通/波及/連鎖）棋盤即時標記，可拖拉操作選單避免遮擋。
- 獻祭操作使用棋盤浮動選單，確認彈窗出現時自動隱藏。
- 能力啟動 FX：`ABILITY_TRIGGERED` 事件 → 浮字 + 紫藍高亮。
- EffectsModal 顯示靈魂卡 text 描述（附魔能力一覽）。
- 回合背景漸層與棋盤 box-shadow 依紅/綠方切換顯示。
- Intro 頁靈魂卡以氏族頁簽切換呈現（wrapping grid，與道具卡相同排版風格）。
- Graveyard 顯示改為折疊/下拉（避免長 id 造成溢出）。

### Bot / 訓練
- `balanceBot.ts` 實作 epsilon-greedy 決策（buy/necro/combat 三階段）。
- `botWeights.ts` 含 BASE_WEIGHTS / DYNAMIC_WEIGHTS / OPPONENT_WEIGHTS，`getMergedWeights()` 支援 base/dynamic/blend/opponent 模式。
- 自動訓練腳本（`npm run train`）：多輪自對局 → 產生 balanceReport JSON → `updateDynamicWeights.js` 用 Wilson CI + momentum 更新 DYNAMIC_WEIGHTS。
- 訓練機制完全卡牌無關（`listSoulCards()` 自動包含所有已啟用氏族），鐵衛氏族已自動納入訓練並產生動態權重。
- Bot 具備鐵衛氏族意識：買牌偏好由訓練權重驅動；necro 階段會嘗試 LOGISTICS_REVIVE 免費復活卒；偏好在有 tiered aura 存在時多保留卒屍骸。

### 部署
- 已部署至網路，具備正式 domain，可供朋友直接訪問測試。

---

## 下一步（建議優先順序）

1. **道具卡擴充**：目前實作 8 張核心道具。剩餘規則文件內的道具卡（靈魂收割者、死亡連鎖、冥鎖封印、牢籠掠奪、棘荊領域、靈魂剝離針、靈魂觀星儀、冥界稅收）視需求逐步實作。
2. **線上對戰**：Node.js + Socket.IO 後端（權威伺服器模式）。估計 1～2 週可完成 MVP（create/join 房間 + 全狀態廣播 + 斷線重連）。
3. **更多氏族**：血契狂徒血脈、緯度界標（規則文件已有設計草稿）。
4. **Bot 強化**：更細緻的戰鬥行動評分（攻守評估、宮格安全性）；可選：用 MCTS 替換 epsilon-greedy。
5. **氏族能力持續資料驅動化**：逐步將剩餘 hardcode 邏輯移入 ability schema（目前暗月越境、冥河冥雷等仍部分 hardcode）。

---

## 連線同步 / 桌面鏡像：難度評估

### 目標定義

- 連線對戰：建立 Socket 連線、建立/加入房間、同步雙方遊戲狀態。
- 桌面鏡像（更像「觀戰/同螢幕」）：一方操作、另一方只接收狀態與事件（可選：允許請求同步）。

### 建議架構（權威伺服器）

- 伺服器保存每個 room 的 `GameState`，只接受 action（MOVE/SHOOT/BUY/ENCHANT/REVIVE/NEXT_PHASE...）。
- 伺服器在收到 action 時：
  - 先跑 engine guards（canDispatch）
  - 再 reduce
  - 廣播完整 state（或 state + events）

### 難度與風險

- 難度：中（MVP 可在 1～2 週內打通）
- 風險：
  - 斷線重連／狀態回補（必做）
  - 客戶端時鐘/重放（可先不做）
  - 同時送出 action 的競態（伺服器序列化即可解）

### MVP 里程碑

1. 房間：create/join + roomId（localStorage 記住）
2. 同步：
   - client 送 action
   - server reduce
   - server broadcast 最新 state
3. 重連：GET `/api/game/:roomId/state` + Socket `requestState`
4. 桌面鏡像：同房間但設定一方為 observer（不允許送 action）

---

## Electron 打包成 App：可行性評估

### 可行性

- 可行（Vue3/Vite + Electron 是常見組合）。
- 對本專案最大價值：
  - 離線資源打包（卡圖/音效）
  - 桌面快捷啟動
  - 之後可做設定存檔/重連、甚至本機 LAN server。

### 前置與常見卡點

- macOS / Windows 平台打包設定（路徑、icon、base url 等）
- Node 版本固定（20 LTS）

### 建議時程
2. build 出 dmg/exe
3. 設定資料：localStorage（先）/ 後續可加設定檔（房間 ID / 音量 / 顯示偏好）
4. （可選）本機 server 模式：一台當 host，另一台連 LAN